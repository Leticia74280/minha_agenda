version: '3.8'

networks:
  zabbix-net:
    driver: bridge
  app-network:
    driver: bridge

services:
  # PostgreSQL para Zabbix
  postgres-zabbix:
    image: postgres:15-alpine
    container_name: postgres-zabbix
    restart: unless-stopped
    environment:
      POSTGRES_DB: zabbix
      POSTGRES_USER: zabbix
      POSTGRES_PASSWORD: zabbix_pwd
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - zabbix-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U zabbix"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Zabbix Server
  zabbix-server:
    image: zabbix/zabbix-server-pgsql:alpine-6.4-latest
    container_name: zabbix-server
    restart: unless-stopped
    environment:
      DB_SERVER_HOST: postgres-zabbix
      POSTGRES_DB: zabbix
      POSTGRES_USER: zabbix
      POSTGRES_PASSWORD: zabbix_pwd
      ZBX_ENABLE_SNMP_TRAPS: "true"
      ZBX_STARTPOLLERS: 5
      ZBX_CACHESIZE: 128M
    ports:
      - "10051:10051"
    volumes:
      - zabbix-alertscripts:/usr/lib/zabbix/alertscripts
      - zabbix-externalscripts:/usr/lib/zabbix/externalscripts
    networks:
      - zabbix-net
      - app-network
    depends_on:
      postgres-zabbix:
        condition: service_healthy

  # Zabbix Frontend
  zabbix-web:
    image: zabbix/zabbix-web-nginx-pgsql:alpine-6.4-latest
    container_name: zabbix-web
    restart: unless-stopped
    environment:
      DB_SERVER_HOST: postgres-zabbix
      POSTGRES_DB: zabbix
      POSTGRES_USER: zabbix
      POSTGRES_PASSWORD: zabbix_pwd
      ZBX_SERVER_HOST: zabbix-server
      ZBX_SERVER_NAME: "Agenda Monitoring"
      PHP_TZ: America/Recife
    ports:
      - "8080:8080"
    networks:
      - zabbix-net
    depends_on:
      - zabbix-server

  # Zabbix Agent 2 (para monitorar o host)
  zabbix-agent:
    image: zabbix/zabbix-agent2:alpine-6.4-latest
    container_name: zabbix-agent-host
    restart: unless-stopped
    privileged: true
    pid: host
    environment:
      ZBX_HOSTNAME: "Docker-Host"
      ZBX_SERVER_HOST: zabbix-server
      ZBX_SERVER_PORT: 10051
      ZBX_ACTIVE_ALLOW: "true"
    ports:
      - "10050:10050"
    networks:
      - zabbix-net
      - app-network
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
    depends_on:
      - zabbix-server

  # Sua aplicação Agenda (modificada)
  app-agenda:
    build: .
    container_name: minha-agenda-container
    restart: always
    ports:
      - "3000:3000"
    volumes:
      - ./database.db:/app/database.db
    networks:
      - app-network
    environment:
      NODE_ENV: production
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  postgres-data:
  zabbix-alertscripts:
  zabbix-externalscripts:
